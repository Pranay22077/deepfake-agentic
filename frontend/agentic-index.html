<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Raksha Agentic System - Bias Corrected</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
        .model-badge {
            animation: pulse 2s infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                    <div>
                        <h1 class="text-2xl font-bold">E-Raksha Agentic System</h1>
                        <p class="text-blue-100 text-sm">Bias-Corrected Deepfake Detection</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-blue-100">System Status</div>
                        <div id="systemStatus" class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                            <span class="text-sm">Checking...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Upload Section -->
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-xl card-shadow p-8 mb-8">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Upload Video for Analysis</h2>
                    <p class="text-gray-600">Our bias-corrected agentic system will analyze your video using multiple specialist models</p>
                </div>

                <!-- Upload Area -->
                <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
                    <i data-lucide="upload-cloud" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Drop your video here or click to browse</h3>
                    <p class="text-gray-500 mb-4">Supports MP4, AVI, MOV, and other video formats</p>
                    <input type="file" id="videoInput" accept="video/*" class="hidden">
                    <button id="browseBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Browse Files
                    </button>
                </div>

                <!-- Progress Bar -->
                <div id="progressContainer" class="hidden mt-6">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span id="progressText">Processing...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <!-- Main Result -->
                <div class="bg-white rounded-xl card-shadow p-8 mb-6 fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Analysis Results</h3>
                        <div id="biasCorrection" class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                            Bias Correction Applied
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Prediction Result -->
                        <div class="text-center">
                            <div id="predictionIcon" class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center">
                                <i data-lucide="help-circle" class="w-10 h-10"></i>
                            </div>
                            <h4 id="predictionText" class="text-3xl font-bold mb-2">Analyzing...</h4>
                            <p id="confidenceText" class="text-xl text-gray-600 mb-4">Confidence: --</p>
                            <div id="confidenceLevel" class="inline-block px-4 py-2 rounded-full text-sm font-medium">
                                --
                            </div>
                        </div>

                        <!-- Video Info -->
                        <div>
                            <h5 class="font-semibold text-gray-800 mb-3">Video Information</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Filename:</span>
                                    <span id="fileName" class="font-medium">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Best Model:</span>
                                    <span id="bestModel" class="font-medium">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Processing Time:</span>
                                    <span id="processingTime" class="font-medium">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Specialists Used:</span>
                                    <span id="specialistsUsed" class="font-medium">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Explanation -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h5 class="font-semibold text-gray-800 mb-2">Analysis Explanation</h5>
                        <p id="explanation" class="text-gray-700">--</p>
                    </div>
                </div>

                <!-- Model Predictions -->
                <div class="bg-white rounded-xl card-shadow p-8 mb-6 fade-in">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Individual Model Predictions</h3>
                    <div id="modelPredictions" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Model cards will be inserted here -->
                    </div>
                </div>

                <!-- Video Characteristics -->
                <div class="bg-white rounded-xl card-shadow p-8 fade-in">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Video Characteristics</h3>
                    <div id="videoCharacteristics" class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Characteristics will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Error Section -->
            <div id="errorSection" class="hidden bg-red-50 border border-red-200 rounded-xl p-6 fade-in">
                <div class="flex items-center space-x-3">
                    <i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>
                    <h3 class="text-lg font-semibold text-red-800">Error</h3>
                </div>
                <p id="errorMessage" class="text-red-700 mt-2">--</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 E-Raksha Agentic System. Advanced deepfake detection with bias correction.</p>
        </div>
    </footer>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // API base URL
        const API_BASE = 'http://localhost:8000';

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const videoInput = document.getElementById('videoInput');
        const browseBtn = document.getElementById('browseBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');
        const resultsSection = document.getElementById('resultsSection');
        const errorSection = document.getElementById('errorSection');
        const systemStatus = document.getElementById('systemStatus');

        // Check system status
        async function checkSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    systemStatus.innerHTML = `
                        <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                        <span class="text-sm">Online</span>
                    `;
                } else {
                    throw new Error('System unhealthy');
                }
            } catch (error) {
                console.error('Health check failed:', error);
                systemStatus.innerHTML = `
                    <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                    <span class="text-sm">Offline</span>
                `;
            }
        }

        // File upload handlers
        uploadArea.addEventListener('click', () => videoInput.click());
        browseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            videoInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-blue-400', 'bg-blue-50');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        videoInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // Handle file upload and prediction
        async function handleFileUpload(file) {
            // Validate file type
            if (!file.type.startsWith('video/')) {
                showError('Please select a valid video file.');
                return;
            }

            // Hide previous results/errors
            resultsSection.classList.add('hidden');
            errorSection.classList.add('hidden');

            // Show progress
            progressContainer.classList.remove('hidden');
            updateProgress(0, 'Uploading video...');

            try {
                const formData = new FormData();
                formData.append('file', file);

                updateProgress(25, 'Processing video...');

                const response = await fetch(`${API_BASE}/predict`, {
                    method: 'POST',
                    body: formData
                });

                updateProgress(75, 'Analyzing with AI models...');

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Prediction failed');
                }

                const result = await response.json();
                updateProgress(100, 'Complete!');

                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    displayResults(result);
                }, 500);

            } catch (error) {
                progressContainer.classList.add('hidden');
                showError(error.message);
            }
        }

        // Update progress bar
        function updateProgress(percent, text) {
            progressBar.style.width = `${percent}%`;
            progressPercent.textContent = `${percent}%`;
            progressText.textContent = text;
        }

        // Display results
        function displayResults(result) {
            // Main prediction
            const predictionIcon = document.getElementById('predictionIcon');
            const predictionText = document.getElementById('predictionText');
            const confidenceText = document.getElementById('confidenceText');
            const confidenceLevel = document.getElementById('confidenceLevel');

            if (result.prediction === 'FAKE') {
                predictionIcon.className = 'w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center bg-red-100';
                predictionIcon.innerHTML = '<i data-lucide="alert-triangle" class="w-10 h-10 text-red-600"></i>';
                predictionText.textContent = 'DEEPFAKE DETECTED';
                predictionText.className = 'text-3xl font-bold mb-2 text-red-600';
            } else {
                predictionIcon.className = 'w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center bg-green-100';
                predictionIcon.innerHTML = '<i data-lucide="check-circle" class="w-10 h-10 text-green-600"></i>';
                predictionText.textContent = 'AUTHENTIC VIDEO';
                predictionText.className = 'text-3xl font-bold mb-2 text-green-600';
            }

            confidenceText.textContent = `Confidence: ${result.confidence}%`;
            
            // Confidence level styling
            const level = result.confidence_level;
            if (level === 'high') {
                confidenceLevel.className = 'inline-block px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800';
                confidenceLevel.textContent = 'High Confidence';
            } else if (level === 'medium') {
                confidenceLevel.className = 'inline-block px-4 py-2 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800';
                confidenceLevel.textContent = 'Medium Confidence';
            } else {
                confidenceLevel.className = 'inline-block px-4 py-2 rounded-full text-sm font-medium bg-red-100 text-red-800';
                confidenceLevel.textContent = 'Low Confidence';
            }

            // Video info
            document.getElementById('fileName').textContent = result.filename;
            document.getElementById('bestModel').textContent = result.details.best_model.toUpperCase();
            document.getElementById('processingTime').textContent = `${result.details.processing_time}s`;
            document.getElementById('specialistsUsed').textContent = result.details.specialists_used.join(', ').toUpperCase();
            document.getElementById('explanation').textContent = result.explanation;

            // Model predictions
            displayModelPredictions(result.details.all_predictions);

            // Video characteristics
            displayVideoCharacteristics(result.details.video_characteristics);

            // Show results
            resultsSection.classList.remove('hidden');
            lucide.createIcons();
        }

        // Display individual model predictions
        function displayModelPredictions(predictions) {
            const container = document.getElementById('modelPredictions');
            container.innerHTML = '';

            const modelNames = {
                'student': 'Baseline Model',
                'cm': 'Compression Specialist',
                'rr': 'Re-recording Specialist',
                'll': 'Low-light Specialist',
                'tm': 'Temporal Specialist',
                'av': 'Audio-Visual Specialist'
            };

            Object.entries(predictions).forEach(([model, data]) => {
                const card = document.createElement('div');
                card.className = 'p-4 border rounded-lg';
                
                const isFake = data.prediction > 50;
                const borderColor = isFake ? 'border-red-200 bg-red-50' : 'border-green-200 bg-green-50';
                card.className += ` ${borderColor}`;

                card.innerHTML = `
                    <h4 class="font-semibold text-gray-800 mb-2">${modelNames[model] || model.toUpperCase()}</h4>
                    <div class="text-2xl font-bold ${isFake ? 'text-red-600' : 'text-green-600'} mb-1">
                        ${data.prediction}%
                    </div>
                    <div class="text-sm text-gray-600">
                        Confidence: ${data.confidence}%
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Display video characteristics
        function displayVideoCharacteristics(characteristics) {
            const container = document.getElementById('videoCharacteristics');
            container.innerHTML = '';

            const charData = [
                { label: 'Resolution', value: `${characteristics.resolution[0]}x${characteristics.resolution[1]}` },
                { label: 'Duration', value: `${characteristics.duration.toFixed(1)}s` },
                { label: 'FPS', value: characteristics.fps.toFixed(1) },
                { label: 'File Size', value: `${(characteristics.file_size / 1024 / 1024).toFixed(1)} MB` },
                { label: 'Bitrate', value: `${(characteristics.bitrate / 1000).toFixed(0)} kbps` },
                { label: 'Brightness', value: characteristics.avg_brightness.toFixed(0) },
                { label: 'Compressed', value: characteristics.is_compressed ? 'Yes' : 'No' },
                { label: 'Low Light', value: characteristics.is_low_light ? 'Yes' : 'No' }
            ];

            charData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'p-3 bg-gray-50 rounded-lg';
                card.innerHTML = `
                    <div class="text-sm text-gray-600">${item.label}</div>
                    <div class="font-semibold text-gray-800">${item.value}</div>
                `;
                container.appendChild(card);
            });
        }

        // Show error
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            errorSection.classList.remove('hidden');
        }

        // Initialize
        checkSystemStatus();
        setInterval(checkSystemStatus, 30000); // Check every 30 seconds
    </script>
</body>
</html>